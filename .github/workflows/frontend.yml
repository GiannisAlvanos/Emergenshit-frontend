name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    # Προσθέτουμε το main και τυχόν άλλα branches (π.χ. develop) για CI
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout (Frontend - Default Repo)
      - name: Checkout Frontend Code
        uses: actions/checkout@v4
      
      # 2. Checkout (Backend - Ξεχωριστό Repo)
      - name: Checkout Backend Code
        uses: actions/checkout@v4
        with:
          # !!! ΠΡΕΠΕΙ ΝΑ ΑΝΤΙΚΑΤΑΣΤΗΣΕΤΕ ΑΥΤΟ ΤΟ PLACEHOLDER !!!
          # Βάλτε το πλήρες όνομα του Backend repository (π.χ. YourUserName/Emergenshit-backend)
          repository: GiannisAlvanos/Emergenshit-backend 
          # Ορίζουμε το path όπου θα κατεβεί ο Backend κώδικας
          path: backend-repo 

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- 3. START BACKEND SERVICE ---
      - name: Install and Start Backend (in background)
        env:
          # Χρειάζεται να περάσουμε το JWT_SECRET για να δουλέψουν τα tests
          # Χρησιμοποιούμε το 'test_secret' που είναι ρυθμισμένο και στο backend.yml
          JWT_SECRET: test_secret 
          # Εάν ο Backend χρειάζεται άλλα secrets (π.χ. MONGODB_URI), προσθέστε τα εδώ
        run: |
          echo "Starting Backend on port 4000..."
          
          # Μετακίνηση στον φάκελο που κατεβάσαμε το Backend
          cd backend-repo 
          
          # Εγκατάσταση εξαρτήσεων Backend (χρησιμοποιούμε npm ci)
          npm ci
          
          # Ξεκίνημα Backend στο παρασκήνιο (npm start)
          npm start & 
          
          # Αναμονή 5 δευτερολέπτων για να ξεκινήσει ο server
          sleep 5
          echo "Backend started."
        
      # --- 4. FRONTEND TESTS ---
      - name: Install dependencies (Frontend)
        # Είμαστε πίσω στον ριζικό φάκελο του Frontend
        run: npm ci

      - name: Run unit tests (if any)
        run: npm test --if-present

      - name: Run Cypress E2E
        uses: cypress-io/github-action@v6
        with:
          start: npm run dev
          wait-on: http://localhost:5173
        env:
          # ΤΩΡΑ το VITE_API_URL πρέπει να δείχνει στο Backend που μόλις ξεκινήσαμε
          VITE_API_URL: http://localhost:4000 
          # Αφαιρούμε το secrets.VITE_API_URL για το CI, καθώς το localhost είναι το σωστό
          
  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    # Το Deploy τρέχει μόνο σε push στο main και εφόσον περάσει το test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Deploy to Render
        run: curl -X POST ${{ secrets.RENDER_FRONTEND_HOOK }}